name: Build and Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'pom.xml'
      - 'src/**'
      - '.github/workflows/deploy.yml'

env:
  JAVA_VERSION: '21'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ” Verify Java Installation
        run: |
          echo "========== Java Version =========="
          java -version
          echo ""
          echo "========== Javac Version =========="
          javac -version
          echo ""
          echo "========== Maven Version =========="
          mvn --version
          echo ""
          echo "========== JAVA_HOME =========="
          echo $JAVA_HOME

      - name: ğŸ“¦ Get version from pom.xml
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Project version: $VERSION"

      - name: ğŸ”¨ Compile Java files
        run: |
          mvn clean compile -e

      - name: ğŸ“š Package JAR file
        run: |
          mvn package -DskipTests

      - name: ğŸ“‹ List generated artifacts
        run: |
          echo "========== Files in target/ =========="
          ls -lh target/ || echo "target folder empty"
          echo ""
          echo "========== JAR files =========="
          find target -name "*.jar" -type f

      - name: â¬†ï¸ Upload JAR to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ElytraRace-${{ steps.version.outputs.VERSION }}
          path: target/ElytraRace-${{ steps.version.outputs.VERSION }}.jar
          retention-days: 30
          if-no-files-found: error

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: target/ElytraRace-${{ steps.version.outputs.VERSION }}.jar
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: ElytraRace v${{ steps.version.outputs.VERSION }}
          body: |
            ## ElytraRace v${{ steps.version.outputs.VERSION }}
            
            ### ğŸ“¥ Download
            Download the JAR file from the assets below.
            
            ### ğŸ“– Installation
            1. Download **ElytraRace-${{ steps.version.outputs.VERSION }}.jar**
            2. Place in your server's `plugins/` folder
            3. Restart your server
            
            ### âš™ï¸ Requirements
            - **Server**: Paper 1.21.4+
            - **Java**: Java 21+
            - **Plugins**: WorldEdit 7.3.3+ (optional), WorldGuard 7.0.13+ (optional)
            
            ### ğŸ“š Documentation
            - [Installation Guide](https://github.com/${{ github.repository }}/blob/main/docs/INSTALLATION.md)
            - [Commands Reference](https://github.com/${{ github.repository }}/blob/main/docs/COMMANDS.md)
            - [Configuration Guide](https://github.com/${{ github.repository }}/blob/main/docs/CONFIGURATION.md)
            
            ### ğŸ”— Links
            - [GitHub Repository](https://github.com/${{ github.repository }})
            - [Issue Tracker](https://github.com/${{ github.repository }}/issues)
            - [Discussions](https://github.com/${{ github.repository }}/discussions)
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ Upload to Modrinth (Optional)
        if: env.MODRINTH_TOKEN != ''
        continue-on-error: true
        run: |
          JAR_FILE=$(find target -name "ElytraRace-*.jar" -type f | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ JAR file not found!"
            exit 1
          fi
          
          echo "ğŸ“¤ Uploading to Modrinth: $JAR_FILE"
          
          curl -X POST \
            -H "Authorization: ${{ secrets.MODRINTH_TOKEN }}" \
            -F "data={\"version_number\":\"${{ steps.version.outputs.VERSION }}\",\"version_type\":\"release\",\"loaders\":[\"paper\"],\"game_versions\":[\"1.21.4\"],\"changelog\":\"See GitHub Release for details\"}" \
            -F "file=@$JAR_FILE" \
            https://api.modrinth.com/v2/version \
            --fail-with-body
          
          echo "âœ… Modrinth upload completed!"
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}

      - name: ğŸ“¤ Upload to SpigotMC (Optional)
        if: env.SPIGOT_TOKEN != ''
        continue-on-error: true
        run: |
          JAR_FILE=$(find target -name "ElytraRace-*.jar" -type f | head -1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ JAR file not found!"
            exit 1
          fi
          
          echo "ğŸ“¤ Uploading to SpigotMC: $JAR_FILE"
          
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SPIGOT_TOKEN }}" \
            -F "file=@$JAR_FILE" \
            -F "changelog=See GitHub Release for details" \
            https://api.spiget.org/v2/resources/${{ secrets.SPIGOT_RESOURCE_ID }}/versions \
            --fail-with-body
          
          echo "âœ… SpigotMC upload completed!"
        env:
          SPIGOT_TOKEN: ${{ secrets.SPIGOT_TOKEN }}

      - name: âœ… Build Complete
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… Build Completed Successfully!  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Version: v${{ steps.version.outputs.VERSION }}"
          echo "ğŸ“ JAR File: ElytraRace-${{ steps.version.outputs.VERSION }}.jar"
          echo "ğŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.VERSION }}"
          echo "ğŸ“¥ Artifacts: Available in Actions"
          echo ""