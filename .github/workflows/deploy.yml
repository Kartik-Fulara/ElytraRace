name: Deploy Plugin

on:
  workflow_run:
    workflows: [ "Build Plugin" ]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: üß™ Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: ElytraRace-*
          path: ./artifact

      - name: üìÅ List downloaded files
        run: ls -R ./artifact

      - name: üì¶ Identify JAR file and version
        id: info
        run: |
          JAR_FILE=$(find artifact -name "*.jar" | head -n 1)
          echo "JAR_FILE=$JAR_FILE" >> $GITHUB_OUTPUT
          VERSION=$(echo "$JAR_FILE" | sed -E 's/.*ElytraRace-(.*)\.jar/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      # -----------------------------------------------------
      # GitHub Release
      # -----------------------------------------------------
      - name: üè∑Ô∏è Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.info.outputs.JAR_FILE }}
          tag_name: v${{ steps.info.outputs.VERSION }}
          name: ElytraRace v${{ steps.info.outputs.VERSION }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------
      # Modrinth Upload
      # -----------------------------------------------------
      - name: üîç Check Modrinth configuration
        id: modrinth_check
        run: |
          if [ -n "${{ secrets.MODRINTH_TOKEN }}" ] && [ -n "${{ vars.MODRINTH_PROJECT_ID }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
          fi

      - name: üì§ Upload to Modrinth
        if: steps.modrinth_check.outputs.configured == 'true'
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ vars.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          files: ${{ steps.info.outputs.JAR_FILE }}
          name: "ElytraRace ${{ steps.info.outputs.VERSION }}"
          version: ${{ steps.info.outputs.VERSION }}
          version-type: release
          loaders: |
            paper
            spigot
            purpur
          game-versions: |
            1.21
            1.21.1
            1.21.2
            1.21.3
            1.21.4

      - name: ‚è≠Ô∏è Skipping Modrinth Upload
        if: steps.modrinth_check.outputs.configured == 'false'
        run: |
          echo "‚è≠Ô∏è Modrinth upload skipped ‚Äî missing MODRINTH_TOKEN or MODRINTH_PROJECT_ID"

      # -----------------------------------------------------
      # Spigot Upload
      # -----------------------------------------------------
      - name: üîç Check Spigot configuration
        id: spigot_check
        run: |
          if [ -n "${{ secrets.SPIGOT_TOKEN }}" ] && [ -n "${{ vars.SPIGOT_RESOURCE_ID }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
          fi

      - name: üì§ Upload to SpigotMC
        if: steps.spigot_check.outputs.configured == 'true'
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          spigot-id: ${{ vars.SPIGOT_RESOURCE_ID }}
          spigot-token: ${{ secrets.SPIGOT_TOKEN }}
          files: ${{ steps.info.outputs.JAR_FILE }}
          name: "ElytraRace ${{ steps.info.outputs.VERSION }}"
          version: ${{ steps.info.outputs.VERSION }}

      - name: ‚è≠Ô∏è Skipping SpigotMC Upload
        if: steps.spigot_check.outputs.configured == 'false'
        run: |
          echo "‚è≠Ô∏è SpigotMC upload skipped ‚Äî missing SPIGOT_TOKEN or SPIGOT_RESOURCE_ID"
